# Waypoint Ingestion Pipeline - Docker Compose Configuration

services:
  # =============================================================================
  # Main Ingestion Service
  # =============================================================================
  ingestion:
    build:
      context: .
      dockerfile: Dockerfile
    image: waypoint-ingestion:latest
    container_name: waypoint-ingestion

    volumes:
      # Knowledge base documents (read-only)
      - ../01_knowledge_base:/app/knowledge_base:ro
      # ChromaDB persistent storage (read-write)
      - ./chroma_db:/app/chroma_db:rw
      # Logs directory (read-write)
      - ./logs:/app/logs:rw

    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - KNOWLEDGE_BASE_PATH=/app/knowledge_base
      - CHROMA_PERSIST_PATH=/app/chroma_db
      - LOG_DIR=/app/logs
      - COLLECTION_NAME=${COLLECTION_NAME:-waypoint_kb}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-gemini-embedding-001}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-768}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    # Allow passing CLI arguments (--verbose, --dry-run, --category)
    # Usage: docker-compose run --rm ingestion --verbose
    stdin_open: true
    tty: true

  # =============================================================================
  # Verification Service (only runs with --profile verify)
  # =============================================================================
  verify:
    build:
      context: .
      dockerfile: Dockerfile
    image: waypoint-ingestion:latest
    container_name: waypoint-verify
    profiles:
      - verify

    volumes:
      - ../01_knowledge_base:/app/knowledge_base:ro
      - ./chroma_db:/app/chroma_db:ro
      - ./logs:/app/logs:rw

    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - KNOWLEDGE_BASE_PATH=/app/knowledge_base
      - CHROMA_PERSIST_PATH=/app/chroma_db
      - LOG_DIR=/app/logs
      - COLLECTION_NAME=${COLLECTION_NAME:-waypoint_kb}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-gemini-embedding-001}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-768}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    # Override entrypoint for verification
    entrypoint: ["python", "scripts/verify_ingestion.py"]
